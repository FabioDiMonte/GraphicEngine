/*! GraphicEngine Package - v0.1.0 - 2015-04-21 */
var GraphicEngine=function(){var a=function(){function a(){this._attributes={}}return a.prototype={set:function(a,b){return this._attributes[a]=b,this},get:function(a){return this._attributes[a]},extend:function(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]&&a[c]instanceof Object&&!(a[c]instanceof Array)?this.extend(a[c],b[c]):a[c]=b[c])}},a}(),b=function(){function a(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0}return a.prototype={toOrtho:function(){return new a([this.x-this.y,(this.x+this.y)/2-1.25*this.z],0)},toIso:function(){return new a([this.y+this.x/2,this.y-this.x/2],0)},toString:function(){return"{x:"+this.x+", y:"+this.y+", z:"+this.z+"}"},toObject:function(){return{x:this.x,y:this.y,z:this.z}},toArray:function(){return[this.x,this.y,this.z]},add:function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z)},subtract:function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z)},multiply:function(b){return new a(this.x*b.x,this.y*b.y,this.z*b.z)},distance:function(a){var b=Math.abs(this.x-a.x),c=Math.abs(this.y-a.y),d=Math.abs(this.z-a.z),e=Math.sqrt(Math.pow(b,2)+Math.pow(c,2));return Math.sqrt(Math.pow(e,2)+Math.pow(d,2))}},a}(),c=function(){function a(a){this._stepCallback=null,this._animation=null,this._startTime=0,a&&this.setCallback(a),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}()}return a.prototype={setCallback:function(a){this._stepCallback=a},start:function(a){this._startTime=(new Date).getTime(),this._animate(),a&&setTimeout(function(){this.stop()}.bind(this),a)},stop:function(){cancelRequestAnimFrame(this._animation),this._animation=null},_animate:function(){this._stepRender(),this._animation=requestAnimFrame(this._animate.bind(this))},_stepRender:function(){var a=(new Date).getTime()-this._startTime;this._stepCallback&&this._stepCallback(a)}},a}(),d=function(){function a(a){this.context=a,this.message=null,this.messageOrigin={x:0,y:0},this.isPath=!1,this.isStroke=!1}return a.prototype={setup:function(a){a||(a={});var b=null==a.fillColor?null:this.castToColor(a.fillColor),c=null==a.strokeColor?null:this.castToColor(a.strokeColor),d=a.strokeSize;this.context.fillStyle=b,this.context.strokeStyle=c,this.context.lineWidth=d,this.context.globalAlpha=a.alpha||1,this.context.font=a.font||"20px Open Sans",this.isStroke=null!=c,this.isPath=null!=b,this.isPath&&this.context.beginPath()},render:function(){this.message&&(this.isPath&&this.context.fillText(this.message,this.messageOrigin.x,this.messageOrigin.y),this.isStroke&&this.context.strokeText(this.message,this.messageOrigin.x,this.messageOrigin.y),this.message=null),this.isPath&&this.context.closePath(),this.isPath&&this.context.fill(),this.isPath=!1,this.isStroke&&this.context.stroke(),this.isStroke=!1},moveTo:function(a,b){var c=this.isPath||this.isStroke;return c&&this.context.moveTo(a,b),c},lineTo:function(a,b){var c=this.isPath||this.isStroke;return c&&this.context.lineTo(a,b),c},text:function(a,b){if(!a)return[];b||(b=[0,0]),b=this.castToPoint(b),this.messageOrigin=b,this.message=a;var c=this.context.measureText(a),d=this.context.font,e=Math.ceil(c.width),f=parseInt(d);return isNaN(f)&&(d=d.substr(d.indexOf(" ")),f=parseInt(d)),[b.add([0,0]),b.add([e,0]),b.add([e,-f]),b.add([0,-f])]},line:function(a,b){if(!a||!b)return!1;a=this.castToPoint(a),b=this.castToPoint(b);var c={from:a,to:b};return this.moveTo(c.from.x,c.from.y)&&this.lineTo(c.to.x,c.to.y)},polygon:function(a,b){if(!a)return[];b||(b=[0,0]),b=this.castToPoint(b);var c,d,e=b.add(a[0]),f=[];for(this.moveTo(e.x,e.y)&&f.push(e),c=1;c<a.length;c++)d=b.add(a[c]),this.lineTo(d.x,d.y)&&f.push(d);return this.lineTo(e.x,e.y),f},castToColor:function(a){var b="string"==typeof a?a:"number"==typeof a?a.toString(16):null;return null!=b&&"#"==b.substr(0,1)&&(b=b.substr(1)),null!=b&&(b="#"+("00000"+b).substr(-6)),b},castToPoint:function(a){var c;return a instanceof b?c=a:"object"==typeof a&&null!=a.x&&null!=a.y?c=new b(a.x,a.y,a.z):"object"==typeof a&&a.length>1&&a.length<4&&(c=new b(a[0],a[1],a[2])),c}},a}(),e=function(a,b){function c(c){if(!c)throw new Error('no "name" provided for this displayObject:',this);if("_"===c[0])throw new Error("DisplayObject names cannot begin with underscore");a.call(this),this._info={name:c,zIndex:0,position:new b,parent:null,shape:null,stepCallback:null,renderMethod:null,renderInfo:null},this._options={strokeColor:0,fillColor:0,strokeSize:1,alpha:1,font:"14px Arial"}}return c.prototype=Object.create(a.prototype),c.prototype.addTo=function(a,b){this._info.zIndex=b||0,this._info.parent=a},c.prototype.remove=function(){delete this},c.prototype.setOptions=function(a){return a?(this.extend(this._options,a),!0):!1},c.prototype.render=function(a){if(!this._info.renderMethod)throw new Error("no renderMethod set for this instance of DisplayObject: ",this);return this._info.renderInfo?(a.draw.setup(this._options),this._info.shape=a.draw[this._info.renderMethod](this._info.renderInfo,this._info.position),a.draw.render(),!0):!1},c.prototype.setRenderInfo=function(a,b){b&&this.setOptions(b),this._info.renderInfo=a},c.prototype.step=function(a){return this._info.stepCallback&&this._info.stepCallback(a),!0},c.prototype.setAnimationStep=function(a){this._info.stepCallback=a},c}(a,b),f=function(a){function b(b){a.call(this,b),this._info.renderMethod="image"}return b.prototype=Object.create(a.prototype),b.prototype.render=function(){},b}(e),g=function(a){function b(b){a.call(this,b),this._options.font=this.getFont("Verdana",14),this._options.fillColor=0,this._options.strokeColor=null,this._info.renderMethod="text"}return b.prototype=Object.create(a.prototype),b}(e),h=function(a){function b(b){a.call(this,b),this._options.fillColor=null,this._options.strokeColor=0,this._info.renderMethod="polygon"}return b.prototype=Object.create(a.prototype),b}(e),i=function(a){function b(b){a.call(this,b),this._info.children=[]}return b.prototype=Object.create(a.prototype),b.prototype.render=function(a){for(var b=0;b<this._info.children.length;b++)this._info.children[b].render(a)},b.prototype.step=function(b){for(var c=0;c<this.children.length;c++)this._info.children[c].step(b);return a.prototype.step.call(this,b),!0},b.prototype.addChild=function(b){if(!(b instanceof a))throw new Error("adding child with unsupported type:",typeof b);return this._info.children.push(b),this[b._info.name]=b,b.addTo(this,this._info.children.length-1),b},b.prototype.addChildAt=function(){},b.prototype.removeChild=function(a){a&&(delete this[a.name],a.remove())},b.prototype.removeChildAt=function(){},b.prototype.removeChildByName=function(a){this.removeChild(this[a])},b.prototype.getShapes=function(){for(var a,c=[],d=0;d<this._info.children.length;d++)a=this._info.children[d],a.shape&&c.push(a.shape),a instanceof b&&(c=c.concat(a.getShapes()));return c},b.prototype.getShapesWithObjects=function(){for(var a,c=[],d=0;d<this._info.children.length;d++)a=this._info.children[d],a.shape&&c.push(a),a instanceof b&&(c=c.concat(a.getShapesWithObjects()));return c},b}(e),j=function(a,b){function e(e){b.call(this,"_stage_"+e),this._info.animator=new c(this.renderTime.bind(this)),this._info.size={w:0,h:0},this._info.grid=!1,this._info.canvas=document.createElement("canvas"),this._info.context=this._info.canvas.getContext("2d"),this._info.draw=new d(this._info.context),this.$el=a("<div/>").addClass("iso-layer").css({position:"absolute",top:0,left:0}).append(this._info.canvas)}return e.prototype=Object.create(b.prototype),e.prototype.render=function(){this.clear(),b.prototype.render.call(this,this)},e.prototype.remove=function(){this.$el.remove()},e.prototype.addTo=function(a){if(a){if(!(a instanceof require("GraphicEngine")))throw new Error("stage added to unsupported object:",typeof a);var b=a.worldSize();this.setSize(b.w,b.h),this.$el.appendTo(a.$el),this._info.parent=a}},e.prototype.clear=function(){this._info.context.clearRect(-this._info.size.w/2,-this._info.size.h/2,this._info.size.w,this._info.size.h)},e.prototype.getCanvas=function(){return this._info.canvas},e.prototype.renderTime=function(a){this.step(a)&&this.render()},e.prototype.startAnimation=function(a){this._info.animator.start(a)},e.prototype.stopAnimation=function(){this._info.animator.stop()},e.prototype.setSize=function(a,b){this._info.size={w:a,h:b},this._info.canvas.width=a.toString(),this._info.canvas.height=b.toString(),this._info.context.translate(a/2,b/2)},e.prototype.setShadow=function(a,b,c,d){this._info.context.shadowColor=a||"#999",this._info.context.shadowBlur=b||20,this._info.context.shadowOffsetX=c||15,this._info.context.shadowOffsetY=d||c||15},e}(jQuery,i),k=function(a){function b(b){a.call(this,b)}return b.prototype=Object.create(a.prototype),b}(i),l=function(a,b,c,d,e,f,g,h,i,j,k){var l={};return l.core={},l.core.ObjectModel=a,l.core.Point=b,l.display={},l.display.Bitmap=c,l.display.DisplayObject=d,l.display.DisplayObjectContainer=e,l.display.Shape=f,l.display.Sprite=g,l.display.Stage=h,l.display.Text=i,l.utils={},l.utils.Animator=j,l.utils.Draw=k,l}(a,b,f,e,i,h,k,j,g,c,d),m=function(a,b,c){function d(){this.$el=a("<div/>"),this.layers={},this.fpsInterval=null,this.fpsLogInterval=null,this.utils={worldSizeWidth:400,worldSizeHeight:400}}function e(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d].y<=b.y&&b.y<a[f].y||a[f].y<=b.y&&b.y<a[d].y)&&b.x<(a[f].x-a[d].x)*(b.y-a[d].y)/(a[f].y-a[d].y)+a[d].x&&(c=!c);return c}return d.prototype={packages:b,init:function(b,c){if(!b)throw new Error('no "elem" param passed to new GraphicEngine instance');c&&a.extend(this.utils,c),this.setWorld(b)},setWorld:function(b){if(this.$el){var c=this.worldSize();this.$el.css("position","relative").width(c.w).height(c.h).appendTo(a(b))}},worldSize:function(){return{w:this.utils.worldSizeWidth,h:this.utils.worldSizeHeight}},render:function(){for(var a in this.layers)this.layers.hasOwnProperty(a)&&this.layers[a].render()},addLayer:function(a){var b=new c(a);return b.addTo(this),this.layers[a]=b,b},removeLayer:function(a){var b=this.layers[a];return b?(b.remove(),delete this.layers[a],!0):!1},showFPS:function(a){a||(a=console.log);var b=0;this.fpsInterval=setInterval(function(){b++},1),this.fpsLogInterval=setInterval(function(){a(b/10),b=0},1e3)},hideFPS:function(){clearInterval(this.fpsInterval),clearInterval(this.fpsLogInterval)},screenToWorld:function(a,b){var c=this.worldSize(),d=this.$el.offset();return{x:a-(d.left+c.w/2),y:b-(d.top+c.h/2)}},getObjectsAtScreenCoord:function(a){var b=this.screenToWorld(a.x,a.y),c=[];for(var d in this.layers)this.layers.hasOwnProperty(d)&&(c=c.concat(this.layers[d].getShapesWithObjects()));for(var f=[],g=0;g<c.length;g++)c[g].shape&&e(c[g].shape,b)&&f.push(c[g]);return f.sort(function(a,b){return b.zindex-a.zindex}),f}},d}(jQuery,l,j);return m}();