/*! GraphicEngine Package - v0.1.0 - 2015-04-23 */
var GraphicEngine=function(){var a=function(){function a(){this._attributes={}}return a.prototype={set:function(a,b){return this._attributes[a]=b,this},get:function(a){return this._attributes[a]},_extend:function(a,b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]&&a[c]instanceof Object&&!(a[c]instanceof Array)?this._extend(a[c],b[c]):a[c]=b[c])}},a}(),b=function(){function a(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0}return a.prototype={toOrtho:function(){return new a([this.x-this.y,(this.x+this.y)/2-1.25*this.z],0)},toIso:function(){return new a([this.y+this.x/2,this.y-this.x/2],0)},toString:function(){return"{x:"+this.x+", y:"+this.y+", z:"+this.z+"}"},toObject:function(){return{x:this.x,y:this.y,z:this.z}},toArray:function(){return[this.x,this.y,this.z]},add:function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z)},subtract:function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z)},multiply:function(b){return new a(this.x*b.x,this.y*b.y,this.z*b.z)},distance:function(a){var b=Math.abs(this.x-a.x),c=Math.abs(this.y-a.y),d=Math.abs(this.z-a.z),e=Math.sqrt(Math.pow(b,2)+Math.pow(c,2));return Math.sqrt(Math.pow(e,2)+Math.pow(d,2))}},a}(),c=function(){function a(a){this._stepCallback=null,this._animation=null,this._startTime=0,a&&this.setCallback(a),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}()}return a.prototype={setCallback:function(a){this._stepCallback=a},start:function(a){this._startTime=(new Date).getTime(),this._animate(),a&&setTimeout(function(){this.stop()}.bind(this),a)},stop:function(){cancelRequestAnimFrame(this._animation),this._animation=null},_animate:function(){this._stepRender(),this._animation=requestAnimFrame(this._animate.bind(this))},_stepRender:function(){var a=(new Date).getTime()-this._startTime;this._stepCallback&&this._stepCallback(a)}},a}(),d=function(){function a(a){this.context=a,this.message=null,this.messageOrigin={x:0,y:0},this.isPath=!1,this.isStroke=!1}return a.prototype={setup:function(a){a||(a={});var b=null==a.fillColor?null:this.castToColor(a.fillColor),c=null==a.strokeColor?null:this.castToColor(a.strokeColor),d=a.strokeSize;this.context.fillStyle=b,this.context.strokeStyle=c,this.context.lineWidth=d,this.context.globalAlpha=a.alpha||1,this.context.font=a.font||"20px Open Sans",this.isStroke=null!=c,this.isPath=null!=b,this.isPath&&this.context.beginPath()},render:function(){this.message&&(this.isPath&&this.context.fillText(this.message,this.messageOrigin.x,this.messageOrigin.y),this.isStroke&&this.context.strokeText(this.message,this.messageOrigin.x,this.messageOrigin.y),this.message=null),console.log("### Draw.render() ###"),console.log("isPath",this.isPath),console.log("isStroke",this.isStroke),console.log("context",this.context),this.isPath&&this.context.closePath(),this.isPath&&this.context.fill(),this.isPath=!1,this.isStroke&&this.context.stroke(),this.isStroke=!1},moveTo:function(a,b){var c=this.isPath||this.isStroke;return c&&this.context.moveTo(a,b),console.log("Draw.moveTo(%d,%d) - canDraw ? %o",a,b,c),c},lineTo:function(a,b){var c=this.isPath||this.isStroke;return c&&this.context.lineTo(a,b),console.log("Draw.lineTo(%d,%d) - canDraw ? %o",a,b,c),c},text:function(a,b){if(!a)return[];b||(b=[0,0]),b=this.castToPoint(b),this.messageOrigin=b,this.message=a;var c=this.context.measureText(a),d=this.context.font,e=Math.ceil(c.width),f=parseInt(d);return isNaN(f)&&(d=d.substr(d.indexOf(" ")),f=parseInt(d)),[b.add([0,0]),b.add([e,0]),b.add([e,-f]),b.add([0,-f])]},line:function(a,b,c){return a&&b?(a=this.castToPoint(a),b=this.castToPoint(b),c&&(a=a.toOrtho(),b=b.toOrtho()),this.moveTo(a.x,a.y)&&this.lineTo(b.x,b.y)):!1},polygon:function(a,b,c){if(!a)return[];b||(b=[0,0]),b=this.castToPoint(b),c&&(a=a.map(function(a){return this.castToPoint(a).toOrtho()}.bind(this)));var d,e,f=b.add(a[0]),g=[];for(this.moveTo(f.x,f.y)&&g.push(f),d=1;d<a.length;d++)e=b.add(a[d]),this.lineTo(e.x,e.y)&&g.push(e);return this.lineTo(f.x,f.y),g},castToColor:function(a){var b="string"==typeof a?a:"number"==typeof a?a.toString(16):null;return null!=b&&"#"==b.substr(0,1)&&(b=b.substr(1)),null!=b&&(b="#"+("00000"+b).substr(-6)),b},castToPoint:function(a){var c;return a instanceof b?c=a:"object"==typeof a&&null!=a.x&&null!=a.y?c=new b(a.x,a.y,a.z):"object"==typeof a&&a.length>1&&a.length<4&&(c=new b(a[0],a[1],a[2])),c}},a}(),e=function(a,b){function c(c){if(!c)throw new Error('no "name" provided for this displayObject:',this);if(a.call(this),this._name=c,this._parent=null,this._zIndex=0,this._position=new b,this._shape=null,this._info={stepCallback:null,renderMethod:null,renderInfo:null},this._options={strokeColor:0,fillColor:0,strokeSize:1,alpha:1,font:"14px Arial"},this[c])throw new Error('property "%s" already exists on',c,this)}return c.prototype=Object.create(a.prototype),c.prototype.setOptions=function(a){return a?(this._extend(this._options,a),!0):!1},c.prototype.setRenderInfo=function(a,b){b&&this.setOptions(b),this._info.renderInfo=a},c.prototype.setAnimationStep=function(a){this._info.stepCallback=a},c.prototype._addTo=function(a,b){this._zIndex=b||0,this._parent=a},c.prototype._remove=function(){delete this},c.prototype._render=function(a){if(!this._info.renderMethod)throw new Error("no renderMethod set for this instance of DisplayObject: ",this);return this._info.renderInfo?(a._info.draw.setup(this._options),this._shape=a.draw[this._info.renderMethod](this._info.renderInfo,this._position),a._info.draw.render(),!0):!1},c.prototype._step=function(a){return this._info.stepCallback&&this._info.stepCallback(a),!0},c}(a,b),f=function(a){function b(b){a.call(this,b),this._info.renderMethod="image"}return b.prototype=Object.create(a.prototype),b.prototype.render=function(){},b}(e),g=function(a){function b(b){a.call(this,b),this._options.font=this.getFont("Verdana",14),this._options.fillColor=0,this._options.strokeColor=null,this._info.renderMethod="text"}return b.prototype=Object.create(a.prototype),b}(e),h=function(a){function b(b){a.call(this,b),this._options.fillColor=null,this._options.strokeColor=0,this._info.renderMethod="polygon"}return b.prototype=Object.create(a.prototype),b}(e),i=function(a){function b(b){a.call(this,b),this._children={},this._childrenLength=function(){var a=0;return c(this,function(){a++}),a}.bind(this._children),this._childrenArray=function(){var a=[];return c(this,function(b){a.push(b)}),a.sort(function(a,b){return a._zIndex-b._zIndex})}.bind(this._children)}function c(a,b){if(a&&b)for(var c in a)a.hasOwnProperty(c)&&b(a[c])}return b.prototype=Object.create(a.prototype),b.prototype._render=function(a){this._childrenArray(!0).forEach(function(b){b._render(a)})},b.prototype._step=function(b){return this._childrenArray(!0).forEach(function(a){a._step(b)}),a.prototype._step.call(this,b),!0},b.prototype.addChild=function(b,c){if(!(b instanceof a))throw new Error("adding child with unsupported type:",typeof b);if(this[b._name])throw new Error('property "',b._name,'" already exists on',this);return c||(c=this._childrenLength()),this._children[b._name]=b,this[b._name]=b,b._addTo(this,c),this._reorderChildren(),b},b.prototype.removeChild=function(b){b instanceof String&&(b=this[b]),b&&this[b._name]&&this[b._name]instanceof a&&(delete this._children[b._name],delete this[b._name],b._remove())},b.prototype._reorderChildren=function(){this._childrenArray().forEach(function(a,b){a._info.index=b})},b.prototype._getShapes=function(){for(var a,c=[],d=0;d<this._children.length;d++)a=this._children[d],a._shape&&c.push(a._shape),a instanceof b&&(c=c.concat(a._getShapes()));return c},b.prototype._getShapesWithObjects=function(){for(var a,c=[],d=0;d<this._children.length;d++)a=this._children[d],a._shape&&c.push(a),a instanceof b&&(c=c.concat(a._getShapesWithObjects()));return c},b}(e),j=function(a,b){function e(e){b.call(this,"_stage_"+e),this._engine=null,this._info.size={w:0,h:0},this._info.canvas=document.createElement("canvas"),this._info.context=this._info.canvas.getContext("2d"),this._info.draw=new d(this._info.context),this._info.animator=new c(this.renderTime.bind(this)),this.$el=a("<div/>").addClass("iso-layer").css({position:"absolute",top:0,left:0}).append(this._info.canvas)}return e.prototype=Object.create(b.prototype),e.prototype._render=function(){this.clear(),b.prototype._render.call(this,this)},e.prototype._remove=function(){this.$el.remove()},e.prototype._addTo=function(a){if(a){var b=a.worldSize();this.setSize(b.w,b.h),this.$el.appendTo(a.$el),this._engine=a}},e.prototype.clear=function(){this._info.context.clearRect(-this._info.size.w/2,-this._info.size.h/2,this._info.size.w,this._info.size.h)},e.prototype.getCanvas=function(){return this._info.canvas},e.prototype.renderTime=function(a){this._step(a)&&this._render()},e.prototype.startAnimation=function(a){this._info.animator.start(a)},e.prototype.stopAnimation=function(){this._info.animator.stop()},e.prototype.setSize=function(a,b){this._info.size={w:a,h:b},this._info.canvas.width=a.toString(),this._info.canvas.height=b.toString(),this._info.context.translate(a/2,b/2)},e.prototype.setShadow=function(a,b,c,d){this._info.context.shadowColor=a||"#999",this._info.context.shadowBlur=b||20,this._info.context.shadowOffsetX=c||15,this._info.context.shadowOffsetY=d||c||15},e}(jQuery,i),k=function(a){function b(b){a.call(this,b)}return b.prototype=Object.create(a.prototype),b}(i),l=function(a,b,c,d,e,f,g,h,i,j,k){var l={};return l.core={},l.core.ObjectModel=a,l.core.Point=b,l.display={},l.display.Bitmap=c,l.display.DisplayObject=d,l.display.DisplayObjectContainer=e,l.display.Shape=f,l.display.Sprite=g,l.display.Stage=h,l.display.Text=i,l.utils={},l.utils.Animator=j,l.utils.Draw=k,l}(a,b,f,e,i,h,k,j,g,c,d),m=function(a,b,c,d){function e(){this.$el=a("<div/>"),this.layers={},this.fpsInterval=null,this.fpsLogInterval=null,this.utils={worldSizeWidth:400,worldSizeHeight:400}}function f(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d].y<=b.y&&b.y<a[f].y||a[f].y<=b.y&&b.y<a[d].y)&&b.x<(a[f].x-a[d].x)*(b.y-a[d].y)/(a[f].y-a[d].y)+a[d].x&&(c=!c);return c}return e.prototype={packages:b,init:function(b,c){if(!b)throw new Error('no "elem" param passed to new GraphicEngine instance');c&&a.extend(!0,this.utils,c),this.setWorld(b)},setWorld:function(b){if(this.$el){var c=this.worldSize();this.$el.css("position","relative").width(c.w).height(c.h).appendTo(a(b))}},worldSize:function(){return{w:this.utils.worldSizeWidth,h:this.utils.worldSizeHeight}},render:function(){for(var a in this.layers)this.layers.hasOwnProperty(a)&&this.layers[a].render()},addLayer:function(a){var b=new c(a);return b._addTo(this),this.layers[a]=b,b},removeLayer:function(a){var b=this.layers[a];return b?(b.remove(),delete this.layers[a],!0):!1},showFPS:function(a){a||(a=console.log);var b=0;this.fpsInterval=setInterval(function(){b++},1),this.fpsLogInterval=setInterval(function(){a(b/10),b=0},1e3)},hideFPS:function(){clearInterval(this.fpsInterval),clearInterval(this.fpsLogInterval)},screenToWorld:function(a,b){var c=this.worldSize(),d=this.$el.offset();return{x:a-(d.left+c.w/2),y:b-(d.top+c.h/2)}},getObjectsAtScreenCoord:function(a){var b=this.screenToWorld(a.x,a.y),c=[];for(var d in this.layers)this.layers.hasOwnProperty(d)&&(c=c.concat(this.layers[d].getShapesWithObjects()));for(var e=[],g=0;g<c.length;g++)c[g].shape&&f(c[g].shape,b)&&e.push(c[g]);return e.sort(function(a,b){return b.zindex-a.zindex}),e},draw:{grid:function(a,b,c,e,f){if(!a)throw new Error("calling draw method without providing a Stage instance");b||(b=[10,10]),c||(c=10),e||(e={}),e.strokeSize||(e.strokeSize=1),e.strokeColor||(e.strokeColor=0),e.alpha||(e.alpha=.8);var g,h;a._info.draw.setup(e);for(var i=0;i<=b[0];i++)g=new d(i*c,0),h=new d(i*c,b[0]*c),a._info.draw.line(g,h,f);for(var j=0;j<=b[1];j++)g=new d(0,j*c),h=new d(b[1]*c,j*c),a._info.draw.line(g,h,f);a._info.draw.render()},line:function(a,b,c,d,e){if(!a)throw new Error("calling draw method without providing a Stage instance");null!=b&&null!=c&&(d&&a._info.draw.setup(d),a._info.draw.line(b,c,e),a._info.draw.render())},axis:function(a,b,c){if(!a)throw new Error("calling draw method without providing a Stage instance");b||(b=100);var d=[b,0,0],e=[0,b,0],f=[0,0,b];a._info.draw.setup({strokeColor:0}),a._info.draw.line([0,0,0],d,c),a._info.draw.line([0,0,0],e,c),a._info.draw.line([0,0,0],f,c),a._info.draw.render()},get3DPolygonSquare:function(a){return[[0,0,0],[a,0,0],[a,a,0],[0,a,0]]},get3DPolygonSquareRight:function(a){return[[0,0,0],[0,a,0],[0,a,a],[0,0,a]]},get3DPolygonSquareLeft:function(a){return[[0,0,0],[0,0,a],[a,0,a],[a,0,0]]}}},e}(jQuery,l,j,b);return m}();